import re
from pathlib import Path

# Generated by chatGPT
def levenshtein(a, b):
    dp = list(range(len(b) + 1))
    for i, ca in enumerate(a, 1):
        new_dp = [i]
        for j, cb in enumerate(b, 1):
            cost = 0 if ca == cb else 1
            new_dp.append(min(
                dp[j] + 1,
                new_dp[j-1] + 1,
                dp[j-1] + cost
            ))
        dp = new_dp
    return dp[-1]


def evaluate_ocr_folder(results_dir, ground_truth, ignore_case=True):
    """
    Returns a dict: {filename: accuracy_percent}
    """

    results_dir = Path(results_dir)

    # Normalize ground truth once
    gt_clean = re.sub(r"\s+", "", ground_truth)
    if ignore_case:
        gt_clean = gt_clean.lower()

    scores = {}

    for txt_file in results_dir.glob("*.txt"):
        ocr_output = txt_file.read_text(encoding="utf-8")
        ocr_clean = re.sub(r"\s+", "", ocr_output)

        if ignore_case:
            ocr_clean = ocr_clean.lower()

        dist = levenshtein(gt_clean, ocr_clean)
        accuracy = (1 - dist / len(gt_clean)) * 100

        scores[txt_file.name] = accuracy

    return scores